{% extends 'tracker/base.html' %}
{% block title %}Barcha o‘quvchilar{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h1 class="text-3xl font-semibold text-gray-800">👩‍🎓 Barcha o‘quvchilar</h1>
    <button
      hx-get="{% url 'add_student_global' %}"
      hx-target="#modal-content"
      hx-swap="innerHTML"
      class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow transition"
    >
      Yangi o‘quvchi qo‘shish
    </button>
  </div>

  <!-- Students List -->
  <div id="students-list" class="space-y-3">
    {% for s in students %}
    <div class="bg-white p-4 rounded-lg shadow hover:shadow-md border border-gray-200 transition">
      <a href="{% url 'global_student_detail' s.id %}" class="text-blue-600 text-lg font-medium hover:underline">
        {{ s.full_name }}
      </a>
      <p class="text-sm text-gray-500 mt-1">
        ✏️ Yozilgan sinflar:
        {% for e in s.enrollments.all %}
          <span class="text-gray-700">{{ e.classroom.name }}</span>{% if not forloop.last %}, {% endif %}
        {% empty %}
          <span class="text-gray-400">Hech biri</span>
        {% endfor %}
      </p>
    </div>
    {% empty %}
    <p class="text-gray-500 text-center">Hozircha o‘quvchilar mavjud emas.</p>
    {% endfor %}
  </div>
</div>

<!-- Modal (for Add Student Form) -->
<div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div id="modal-content" class="bg-white rounded-xl shadow-lg w-11/12 sm:w-96 p-6 relative">
    <!-- Content will be loaded via HTMX -->
  </div>
</div>

<script>
  // Show modal automatically when content is loaded
  document.body.addEventListener('htmx:afterOnLoad', (e) => {
    if (e.detail.target.id === 'modal-content') {
      document.getElementById('modal').classList.remove('hidden');
    }
  });

  // Hide modal when clicking outside of it
  document.getElementById('modal').addEventListener('click', (e) => {
    if (e.target.id === 'modal') {
      e.target.classList.add('hidden');
    }
  });

  // When form submission succeeds, refresh students list
  document.body.addEventListener('htmx:afterRequest', (e) => {
    if (e.detail.elt.id === 'student-form') {
      document.getElementById('modal').classList.add('hidden');
      htmx.trigger('#students-list', 'refreshList');
    }
  });

  // Refresh list on custom event
  htmx.on('refreshList', () => {
    htmx.ajax('GET', '{% url "all_students" %}', '#students-list');
  });
</script>
{% endblock %}
